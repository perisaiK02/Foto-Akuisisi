<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Upload Foto - BPJS Ketenagakerjaan Style</title>
<style>
  /* Warna tema */
  :root {
    --biru: #005ea2;
    --hijau: #0f9d58;
    --kuning: #f9a825;
    --putih: #fff;
    --abu-muda: #f3f6f9;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px auto;
    max-width: 480px;
    background-color: var(--abu-muda);
    color: #222;
  }

  h3 {
    color: var(--biru);
    text-align: center;
    margin-bottom: 24px;
  }

  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: var(--biru);
  }

  input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 20px;
    border: 2px solid var(--biru);
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.3s ease;
  }

  input[type="text"]:focus {
    outline: none;
    border-color: var(--hijau);
    background-color: var(--putih);
  }

  video, canvas {
    width: 100%;
    max-width: 480px;
    border: 2px solid var(--biru);
    border-radius: 8px;
    background-color: var(--putih);
    margin-bottom: 20px;
  }

  .buttons {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 20px;
  }

  button {
    flex: 1;
    padding: 12px 0;
    font-size: 16px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: var(--putih);
    transition: background-color 0.3s ease;
  }

  button#start {
    background-color: var(--biru);
  }
  button#start:hover:not(:disabled) {
    background-color: #004080;
  }

  button#capture {
    background-color: var(--hijau);
  }
  button#capture:hover:not(:disabled) {
    background-color: #0b7e43;
  }

  button#upload {
    background-color: var(--kuning);
    color: #222;
    font-weight: 700;
  }
  button#upload:hover:not(:disabled) {
    background-color: #d48806;
  }

  button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }

  #status {
    font-weight: 700;
    font-size: 16px;
    text-align: center;
    padding: 10px;
    border-radius: 6px;
    min-height: 30px;
  }
  #status.success {
    background-color: #d4edda;
    color: #155724;
  }
  #status.error {
    background-color: #f8d7da;
    color: #721c24;
  }
</style>
</head>
<body>

<h3>Ambil Foto & Upload - BPJS Ketenagakerjaan</h3>

<label for="username">Nama User</label>
<input type="text" id="username" placeholder="Masukkan nama Anda" />

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div class="buttons">
  <button id="start">Mulai Kamera</button>
  <button id="capture" disabled>Ambil Foto</button>
  <button id="upload" disabled>Upload</button>
</div>

<div id="status"></div>

<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSH1N5lCLcmBLxPvvU784LjJWeZzcHEzUKgQGubNIt55iMpCGeGhs2hPyJKVLgQK2y1Q/exec'; // Ganti dengan URL Web App kamu
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const startBtn = document.getElementById('start');
  const capBtn = document.getElementById('capture');
  const upBtn = document.getElementById('upload');
  const statusDiv = document.getElementById('status');
  const userInput = document.getElementById('username');

  let lastDataUrl = null;
  let lastLat = '';
  let lastLng = '';
  let lastAddress = '';

  function setStatus(msg, isError = false) {
    statusDiv.textContent = msg;
    statusDiv.className = isError ? 'error' : 'success';
  }

  startBtn.onclick = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      setStatus('Kamera aktif');
      capBtn.disabled = false;
      upBtn.disabled = true;
      canvas.style.display = 'none';
      video.style.display = 'block';
    } catch (e) {
      setStatus('Gagal akses kamera: ' + e.message, true);
    }
  };

  capBtn.onclick = () => {
    if (!navigator.geolocation) {
      setStatus('Geolocation tidak didukung', true);
      return;
    }
    setStatus('Mengambil lokasi...');
    navigator.geolocation.getCurrentPosition((pos) => {
      lastLat = pos.coords.latitude;
      lastLng = pos.coords.longitude;
      lastAddress = `Lat:${lastLat.toFixed(6)}, Lng:${lastLng.toFixed(6)}`;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const rectH = Math.round(canvas.height * 0.08);
      ctx.fillStyle = 'rgba(0,0,0,0.45)';
      ctx.fillRect(0, canvas.height - rectH, canvas.width, rectH);
      ctx.fillStyle = 'white';
      ctx.font = `${Math.max(14, Math.round(canvas.width / 40))}px sans-serif`;
      const ts = new Date().toLocaleString();
      ctx.fillText(ts, 10, canvas.height - rectH / 2 + 6);
      ctx.fillText(lastAddress, 10, canvas.height - rectH / 2 + 28);
      lastDataUrl = canvas.toDataURL('image/jpeg', 0.85);
      setStatus('Foto siap. Tekan Upload.');
      upBtn.disabled = false;
      canvas.style.display = 'block';
      video.style.display = 'none';
    }, (err) => {
      setStatus('Gagal ambil lokasi: ' + err.message, true);
    }, { enableHighAccuracy: true, timeout: 10000 });
  };

  upBtn.onclick = async () => {
    if (!lastDataUrl) {
      setStatus('Tidak ada foto untuk diupload', true);
      return;
    }
    const user = userInput.value.trim() || 'anonymous';
    setStatus('Mengirim ke server...');
    try {
      const params = new URLSearchParams();
      params.append('image', lastDataUrl);
      params.append('lat', lastLat);
      params.append('lng', lastLng);
      params.append('address', lastAddress);
      params.append('timestamp', new Date().toISOString());
      params.append('user', user);
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        body: params
      });
      const json = await resp.json();
      if (json.status === 'ok') {
        setStatus(`Upload sukses â€” file: ${json.fileUrl}`);
        upBtn.disabled = true;
        capBtn.disabled = true;
        startBtn.disabled = true;
        userInput.disabled = true;
      } else {
        setStatus('Upload error: ' + (json.message || 'Unknown'), true);
      }
    } catch (e) {
      setStatus('Request failed: ' + e.message, true);
    }
  };
</script>
</body>
</html>