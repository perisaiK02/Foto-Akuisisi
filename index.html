<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ambil Foto dengan Watermark Perisai K02</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; background: #f0f8ff; margin: 20px; }
  #camera { width: 100%; max-width: 400px; border: 2px solid #4CAF50; border-radius: 10px; }
  canvas { display: none; margin-top: 10px; border-radius: 10px; }
  button { padding: 10px 20px; margin: 10px; border: none; cursor: pointer; background: #4CAF50; color: white; border-radius: 5px; font-size: 16px; }
</style>
</head>
<body>

<h2>Ambil Foto dengan Watermark "Perisai K02"</h2>
<video id="camera" autoplay playsinline></video>
<canvas id="canvas"></canvas><br />
<button id="capture">ðŸ“¸ Ambil Foto</button>

<script>
const video = document.getElementById('camera');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const captureBtn = document.getElementById('capture');

const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwSH1N5lCLcmBLxPvvU784LjJWeZzcHEzUKgQGubNIt55iMpCGeGhs2hPyJKVLgQK2y1Q/exec"; // Ganti dengan URL Apps Script kamu

// Start kamera
navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
  .then(stream => { video.srcObject = stream; })
  .catch(err => alert("Gagal akses kamera: " + err));

// Fungsi ambil alamat lengkap via Nominatim OSM
async function getAddress(lat, lng) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
    const data = await res.json();
    const { suburb = '', city_district = '', city = '', town = '', village = '', county = '' } = data.address || {};
    return {
      kelurahan: suburb,
      kecamatan: city_district,
      kabupaten: city || town || village || county
    };
  } catch {
    return { kelurahan: '', kecamatan: '', kabupaten: '' };
  }
}

captureBtn.addEventListener('click', () => {
  if (!video.videoWidth || !video.videoHeight) {
    alert('Video belum siap, coba lagi sebentar.');
    return;
  }
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    const timestamp = new Date().toLocaleString();

    // Dapatkan alamat lengkap
    const addr = await getAddress(lat, lng);
    const locationText = `Kel: ${addr.kelurahan} | Kec: ${addr.kecamatan} | Kab/Kota: ${addr.kabupaten}`;

    // Gambar watermark berulang diagonal transparan
    ctx.save();
    ctx.globalAlpha = 0.15;
    ctx.fillStyle = "#ffffff";
    ctx.font = `${canvas.width / 15}px Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const text = "Perisai K02";
    const stepX = canvas.width / 4;
    const stepY = canvas.height / 6;
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate(-Math.atan(canvas.height / canvas.width));
    for (let x = -canvas.width; x < canvas.width; x += stepX) {
      for (let y = -canvas.height; y < canvas.height; y += stepY) {
        ctx.fillText(text, x, y);
      }
    }
    ctx.restore();

    // Gambar timestamp & lokasi di bawah
    ctx.fillStyle = "white";
    ctx.font = "24px Arial";
    ctx.textAlign = "left";
    ctx.fillText(timestamp, 10, canvas.height - 60);
    ctx.fillText(locationText, 10, canvas.height - 30);

    canvas.style.display = 'block';

    // Kirim ke Google Apps Script
    const fotoData = canvas.toDataURL("image/jpeg", 0.85);
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({
          image: fotoData,
          lat,
          lng,
          timestamp,
          user: "anonymous",
          address: locationText
        }),
        headers: { "Content-Type": "application/json" }
      });
      const result = await resp.json();
      if (result.status === 'ok') alert("Foto berhasil diunggah!");
      else alert("Upload gagal: " + (result.message || 'unknown error'));
    } catch (e) {
      alert("Gagal upload: " + e.message);
    }

  }, err => {
    alert("Gagal mendapatkan lokasi: " + err.message);
  }, { enableHighAccuracy: true });
});
</script>

</body>
</html>