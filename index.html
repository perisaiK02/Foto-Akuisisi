<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ambil Foto dengan Watermark - Perisai K02</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 480px;
    margin: 20px auto;
    background-color: #f3f6f9;
    color: #222;
    text-align: center;
  }
  video, canvas {
    width: 100%;
    max-width: 480px;
    border: 2px solid #005ea2;
    border-radius: 8px;
    background: white;
    margin-bottom: 16px;
  }
  button {
    background-color: #005ea2;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px;
    font-size: 16px;
    margin: 4px;
    cursor: pointer;
    width: 48%;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  input[type=text] {
    width: 100%;
    padding: 10px 12px;
    font-size: 16px;
    margin-bottom: 16px;
    border: 2px solid #005ea2;
    border-radius: 6px;
  }
  #status {
    font-weight: 700;
    min-height: 30px;
    margin-top: 12px;
  }
  #status.success {
    color: #155724;
    background-color: #d4edda;
    border-radius: 6px;
    padding: 6px;
  }
  #status.error {
    color: #721c24;
    background-color: #f8d7da;
    border-radius: 6px;
    padding: 6px;
  }
</style>
</head>
<body>

<h2>Ambil Foto dengan Watermark Perisai K02</h2>

<label for="username">Nama User</label>
<input type="text" id="username" placeholder="Masukkan nama Anda" />

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div>
  <button id="startBtn">Mulai Kamera</button>
  <button id="captureBtn" disabled>Ambil Foto</button>
  <button id="uploadBtn" disabled>Upload Foto</button>
</div>

<div id="status"></div>

<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSH1N5lCLcmBLxPvvU784LjJWeZzcHEzUKgQGubNIt55iMpCGeGhs2hPyJKVLgQK2y1Q/exec';

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const startBtn = document.getElementById('startBtn');
  const captureBtn = document.getElementById('captureBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const usernameInput = document.getElementById('username');
  const statusDiv = document.getElementById('status');

  let lastImageDataUrl = null;
  let lastLat = '';
  let lastLng = '';
  let lastTimestamp = '';

  function setStatus(msg, isError = false) {
    statusDiv.textContent = msg;
    statusDiv.className = isError ? 'error' : 'success';
  }

  startBtn.addEventListener('click', async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      setStatus('Kamera aktif, silakan ambil foto.');
      captureBtn.disabled = false;
      uploadBtn.disabled = true;
      canvas.style.display = 'none';
      video.style.display = 'block';
    } catch (e) {
      setStatus('Gagal mengakses kamera: ' + e.message, true);
    }
  });

  captureBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      setStatus('Geolocation tidak didukung oleh browser.', true);
      return;
    }
    setStatus('Mengambil lokasi...');
    navigator.geolocation.getCurrentPosition(pos => {
      lastLat = pos.coords.latitude.toFixed(6);
      lastLng = pos.coords.longitude.toFixed(6);
      lastTimestamp = new Date().toLocaleString();

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // gambar frame video ke canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Watermark "Perisai K02" berulang diagonal transparan ala Shutterstock
      ctx.save();
      ctx.globalAlpha = 0.12;
      ctx.fillStyle = "#FFFFFF";
      ctx.font = `${canvas.width / 15}px Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      // rotate canvas untuk watermark diagonal
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(-Math.atan(canvas.height / canvas.width));

      const text = "Perisai K02";
      const stepX = canvas.width / 4;
      const stepY = canvas.height / 6;

      for (let x = -canvas.width; x < canvas.width; x += stepX) {
        for (let y = -canvas.height; y < canvas.height; y += stepY) {
          ctx.fillText(text, x, y);
        }
      }
      ctx.restore();

      // Tambahkan timestamp + koordinat di bawah gambar
      ctx.fillStyle = "white";
      ctx.font = "18px Arial";
      ctx.textAlign = "left";
      ctx.fillText(`${lastTimestamp} | Lat: ${lastLat}, Lng: ${lastLng}`, 10, canvas.height - 20);

      lastImageDataUrl = canvas.toDataURL('image/jpeg', 0.85);

      setStatus('Foto siap untuk diupload.');
      uploadBtn.disabled = false;
      canvas.style.display = 'block';
      video.style.display = 'none';
    }, err => {
      setStatus('Gagal mendapatkan lokasi: ' + err.message, true);
    }, { enableHighAccuracy: true, timeout: 10000 });
  });

  uploadBtn.addEventListener('click', async () => {
    if (!lastImageDataUrl) {
      setStatus('Tidak ada foto untuk diupload.', true);
      return;
    }
    const user = usernameInput.value.trim() || 'anonymous';

    setStatus('Mengirim foto ke server...');
    uploadBtn.disabled = true;

    const params = new URLSearchParams();
    params.append('image', lastImageDataUrl);
    params.append('lat', lastLat);
    params.append('lng', lastLng);
    params.append('timestamp', new Date().toISOString());
    params.append('user', user);
    params.append('address', `Lat:${lastLat},Lng:${lastLng}`);

    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: params,
      });
      const json = await resp.json();
      if (json.status === 'ok') {
        setStatus('Upload sukses! File URL: ' + json.fileUrl);
        uploadBtn.disabled = true;
        captureBtn.disabled = true;
        startBtn.disabled = true;
        usernameInput.disabled = true;
      } else {
        setStatus('Upload gagal: ' + (json.message || 'Tidak diketahui'), true);
        uploadBtn.disabled = false;
      }
    } catch (e) {
      setStatus('Request gagal: ' + e.message, true);
      uploadBtn.disabled = false;
    }
  });
</script>

</body>
</html>